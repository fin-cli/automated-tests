#!/bin/bash

# The phar package to be tested against can be set through the TEST_PHAR
# environment variable.
#
# The following options can be set:
#
# - "none": Skip phar testing.
# - "nightly": Use the nightly phar.
# - "stable": Use the latest stable phar release.
# - "all": Use both the latest stable release phar as well as the nightly phar.

set -e

FAILED_PACKAGES=""

RELEASES=""
REPOS=""

if [ -z "$BUILD_DIR" ]; then
	export BUILD_DIR="${GITHUB_WORKSPACE:-$(pwd)}"
fi

if [ -z "$TEST_PACKAGE" ]; then
	TEST_PACKAGE="all"
fi

if [ "$TEST_PACKAGE" == "none" ]; then
	echo "Skipping feature tests completely."
	exit 0
fi

if [ "$TEST_PACKAGE" == "all" ]; then
	REPOS="fin-cli/fin-cli-bundle
fin-cli/fin-cli
$(cat ${BUILD_DIR}/vendor/fin-cli/fin-cli-bundle/composer.json | grep -oE "fin-cli/([a-z\-]*)-command")"
fi

if [ "$TEST_PACKAGE" == "commands" ]; then
	REPOS="$(cat ${BUILD_DIR}/vendor/fin-cli/fin-cli-bundle/composer.json | grep -oE "fin-cli/([a-z\-]*)-command")"
fi

if [ "$TEST_PACKAGE" != "all" -a "$TEST_PACKAGE" != "commands" ]; then
	REPOS="$TEST_PACKAGE"
fi

if [ -z "$TEST_PHAR" -o "$TEST_PHAR" == "none" ]; then
	echo "Skipping feature tests completely."
	exit 0
fi

if [ "$TEST_PHAR" == "all" ]; then
	RELEASES="nightly
stable"
fi

if [ "$TEST_PHAR" != "all" ]; then
	RELEASES="$TEST_PHAR"
fi

for RELEASE in $RELEASES; do

	echo "Testing $RELEASE Phar distribution..."

	SUFFIX=""
	if [ "$RELEASE" == "nightly" ]; then
		SUFFIX="-nightly"
	fi
	if [ "$RELEASE" == "v2-nightly" ]; then
		SUFFIX="-v2-nightly"
	fi

	PHAR_URL="https://raw.githubusercontent.com/fin-cli/builds/gh-pages/phar/fin-cli${SUFFIX}.phar"
	MD5_URL="${PHAR_URL}.md5"

	# Download binary and verify MD5 checksum.
	BIN_FOLDER="$(mktemp -d)"
	wget -O "${BIN_FOLDER}/fin-cli.phar.md5" "$MD5_URL"
	TARGET_MD5=$(cat "${BIN_FOLDER}/fin-cli.phar.md5")
	wget -O "${BIN_FOLDER}/fin-cli.phar" "$PHAR_URL"
	if hash md5sum 2>/dev/null; then
		DOWNLOAD_MD5=$(md5sum "${BIN_FOLDER}/fin-cli.phar" | cut -d ' ' -f 1)
	else
		DOWNLOAD_MD5=$(md5 -q "${BIN_FOLDER}/fin-cli.phar")
	fi
	if [ ! "$TARGET_MD5" == "$DOWNLOAD_MD5" ]; then
		echo MD5 mismatch, the download for the ${RELEASE} distribution seems to be corrupt.
		exit 1
	fi

	export FIN_CLI_BIN_DIR="${BIN_FOLDER}"
	mv "${FIN_CLI_BIN_DIR}/fin-cli.phar" "${FIN_CLI_BIN_DIR}/fin"
	chmod +x "${BIN_FOLDER}/fin"
	echo "Using binary ${BIN_FOLDER}/fin"

	for REPO in $REPOS; do

		echo "Testing ${RELEASE}:${REPO}..."
		BEHAT_TAGS=$(BEHAT_FEATURES_FOLDER=${BUILD_DIR}/vendor/${REPO}/features php ${BUILD_DIR}/vendor/fin-cli/fin-cli-tests/utils/behat-tags.php)
		echo "Behat Tags: $BEHAT_TAGS"

		set +e
		"${BUILD_DIR}/vendor/bin/behat" --format progress $BEHAT_TAGS --strict  --suite $REPO
		if [ $? -ne 0 ]; then
			"${BUILD_DIR}/vendor/bin/behat" --format progress $BEHAT_TAGS --strict  --suite $REPO --rerun
			if [ $? -ne 0 ]; then
				FAILED_PACKAGES="$FAILED_PACKAGES ${RELEASE}:${REPO}"
			fi
		fi
		set -e

	done

done

if [ -n "$FAILED_PACKAGES" ]; then
	echo "Phar distributions and packages with failed tests:$FAILED_PACKAGES"
	exit 1
fi

echo "Phar distributions were successfully tested."
exit 0
